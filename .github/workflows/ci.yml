name: Shared CI

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    branches: [main]


jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    env:
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit

      - name: Lint check
        run: npx expo lint

      - name: Run unit tests
        run: npm test -- --ci --forceExit --coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Dependency audit
        run: npm audit --omit=dev || true

  web-build:
    name: Web Build
    runs-on: ubuntu-latest
    needs: quality-gate
    env:
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Export web build
        run: npx expo export --platform web

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 7

  web-e2e:
    name: Web E2E Tests
    runs-on: ubuntu-latest
    needs: quality-gate
    env:
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create auth directory
        run: mkdir -p e2e/.auth

      - name: Run Playwright E2E tests
        run: npx playwright test --retries=2
        env:
          CI: true
          EXPO_PUBLIC_E2E_TEST_MODE: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 7

  android-build:
    name: Android Build & Test
    runs-on: ubuntu-latest
    needs: quality-gate
    env:
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Install dependencies
        run: npm ci

      - name: Generate Android project
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}
        run: npx expo prebuild --platform android

      - name: Build Android APK (Debug)
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      #maestro test
      - name: Install Maestro CLI
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Run Maestro tests
        run: maestro test maestro/ --app android/app/build/outputs/apk/debug/*.apk
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_ID_APK: ${{ secrets.AUTH0_CLIENT_ID_APK }}
