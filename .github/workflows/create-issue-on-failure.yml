name: Create Issue on CI Failure

on:
  workflow_run:
    workflows: ["Shared CI", "Web Platform", "Android Platform"]
    types:
      - completed

permissions:
  issues: write
  actions: read
  contents: read

jobs:
  create-failure-issue:
    name: Create Issue on Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get workflow run details
        id: workflow-info
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get workflow run details
            const workflowRun = await github.rest.actions.getWorkflowRun({
              owner,
              repo,
              run_id: runId
            });

            // Get jobs for this workflow run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner,
              repo,
              run_id: runId
            });

            // Filter failed jobs
            const failedJobs = jobs.data.jobs.filter(
              job => job.conclusion === 'failure'
            );

            // Get logs for failed jobs
            let failureLogs = '';
            for (const job of failedJobs) {
              try {
                failureLogs += `\n### Job: ${job.name}\n`;
                failureLogs += `- Status: ${job.conclusion}\n`;
                failureLogs += `- Started: ${job.started_at}\n`;
                failureLogs += `- Completed: ${job.completed_at}\n`;
                const duration = Math.round(
                  (new Date(job.completed_at) - new Date(job.started_at)) / 1000
                );
                failureLogs += `- Duration: ${duration}s\n`;
                failureLogs += `- Log URL: ${job.html_url}\n\n`;

                // Add failed steps
                const failedSteps = job.steps.filter(
                  step => step.conclusion === 'failure'
                );
                if (failedSteps.length > 0) {
                  failureLogs += `Failed Steps:\n`;
                  for (const step of failedSteps) {
                    failureLogs += `- ${step.name} (${step.conclusion})\n`;
                  }
                  failureLogs += `\n`;
                }
              } catch (error) {
                console.error(
                  `Error fetching logs for job ${job.id}:`,
                  error.message
                );
              }
            }

            core.setOutput('workflow_name', workflowRun.data.name);
            core.setOutput('workflow_url', workflowRun.data.html_url);
            core.setOutput('head_branch', workflowRun.data.head_branch);
            core.setOutput('head_sha_full', workflowRun.data.head_sha);
            core.setOutput(
              'head_sha',
              workflowRun.data.head_sha.substring(0, 7)
            );
            core.setOutput('actor', workflowRun.data.actor.login);
            core.setOutput('run_number', workflowRun.data.run_number);
            core.setOutput('failure_logs', failureLogs);
            core.setOutput('failed_jobs_count', failedJobs.length);

      - name: Check for existing open issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflowName = '${{ steps.workflow-info.outputs.workflow_name }}';

            // Search for existing open issues with the same workflow failure
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ci-failure,auto-created',
              per_page: 100
            });

            // Check if there's already an open issue for this workflow
            const existingIssue = issues.data.find(issue =>
              issue.title.includes(workflowName) &&
              issue.title.includes('CI Failure')
            );

            if (existingIssue) {
              core.setOutput('issue_exists', 'true');
              core.setOutput('issue_number', existingIssue.number);
            } else {
              core.setOutput('issue_exists', 'false');
            }

      - name: Create issue for CI failure
        if: steps.check-issue.outputs.issue_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.workflow-info.outputs.workflow_name }}';
            const workflowUrl = '${{ steps.workflow-info.outputs.workflow_url }}';
            const headBranch = '${{ steps.workflow-info.outputs.head_branch }}';
            const headSha = '${{ steps.workflow-info.outputs.head_sha }}';
            const headShaFull = '${{ steps.workflow-info.outputs.head_sha_full }}';
            const actor = '${{ steps.workflow-info.outputs.actor }}';
            const runNumber = '${{ steps.workflow-info.outputs.run_number }}';
            const failedJobsCount = '${{ steps.workflow-info.outputs.failed_jobs_count }}';

            // Get failure logs from step outputs (avoiding template interpolation for multi-line content)
            const failureLogs = process.env.FAILURE_LOGS || 'Failure logs could not be retrieved. Please check the workflow run link above.';

            const title = `CI Failure: ${workflowName} (Run #${runNumber})`;

            const body = [
              '## CI Pipeline Failure Report',
              '',
              `Workflow: ${workflowName}`,
              `Run Number: #${runNumber}`,
              `Branch: \`${headBranch}\``,
              `Commit: \`${headSha}\``,
              `Triggered by: ${actor}`,
              `Failed Jobs: ${failedJobsCount}`,
              '',
              '### Links',
              `- [View Workflow Run](${workflowUrl})`,
              `- [View Commit](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${headShaFull})`,
              '',
              '### Failure Details',
              '',
              failureLogs,
              '',
              '---',
              '',
              '### Action Required',
              '',
              '@copilot Please analyze this CI failure and provide a fix.',
              '',
              'Steps to fix:',
              '1. Review the failure logs above',
              '2. Identify the root cause of the failure',
              '3. Make the necessary code changes to fix the issue',
              '4. Ensure all tests pass',
              '',
              '---',
              '',
              'This issue was automatically created by the CI failure detection workflow.',
              'If this is a flaky test or infrastructure issue, please close this issue and document the problem.'
            ].join('\n');

            // Try to create the issue with copilot assignee, fall back to no assignee if it fails
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'auto-created', 'bug'],
                assignees: ['copilot']
              });
              console.log(`Created issue #${issue.data.number}: ${title}`);
              core.setOutput('issue_number', issue.data.number);
            } catch (error) {
              if (error.message.includes('assignee')) {
                console.log('Warning: Could not assign to copilot user. Creating issue without assignee.');
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['ci-failure', 'auto-created', 'bug']
                });
                console.log(`Created issue #${issue.data.number}: ${title}`);
                core.setOutput('issue_number', issue.data.number);
              } else {
                throw error;
              }
            }
        env:
          FAILURE_LOGS: ${{ steps.workflow-info.outputs.failure_logs }}

      - name: Update existing issue
        if: steps.check-issue.outputs.issue_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.check-issue.outputs.issue_number }}';
            const workflowUrl = '${{ steps.workflow-info.outputs.workflow_url }}';
            const headSha = '${{ steps.workflow-info.outputs.head_sha }}';
            const runNumber = '${{ steps.workflow-info.outputs.run_number }}';

            // Get failure logs from environment variable (avoiding template interpolation for multi-line content)
            const failureLogs = process.env.FAILURE_LOGS || 'Failure logs could not be retrieved. Please check the workflow run link above.';

            const comment = [
              '## Additional Failure Detected',
              '',
              `Run Number: #${runNumber}`,
              `Commit: \`${headSha}\``,
              `Workflow Run: [View Details](${workflowUrl})`,
              '',
              '### Failure Details',
              '',
              failureLogs,
              '',
              '---',
              '',
              'This workflow is still failing. Please review the latest failure information above.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: comment
            });

            console.log(
              `Updated existing issue #${issueNumber} with new failure information`
            );
        env:
          FAILURE_LOGS: ${{ steps.workflow-info.outputs.failure_logs }}
